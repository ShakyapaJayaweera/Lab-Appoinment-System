<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>Lab Appointment System - Report</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
        rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="assets/vendor/animate.css/animate.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet">

    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://cdn.tiny.cloud/1/3povcqtrg9lv35kgmnqvh7leujjkrh1oirpmdbefqyo9hzyu/tinymce/7/tinymce.min.js"
        referrerpolicy="origin"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <style>
        /* The Modal (background) */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
        }

        /* Modal Content/Box */
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            /* Could be more or less, depending on screen size */
        }

        /* The Close Button */
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>

</head>

<body>

    <!-- ======= Top Bar ======= -->
    <div id="topbar" class="d-flex align-items-center fixed-top">
        <div class="container d-flex justify-content-between">
            <div class="contact-info d-flex align-items-center">
                <i class="bi bi-envelope"></i> <a href="mailto:contact@example.com">contact@example.com</a>
                <i class="bi bi-phone"></i> +1 5589 55488 55
            </div>
            <div class="d-none d-lg-flex social-links align-items-center">
                <a href="#" class="twitter"><i class="bi bi-twitter"></i></a>
                <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
                <a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
                <a href="#" class="linkedin"><i class="bi bi-linkedin"></i></i></a>
            </div>
        </div>
    </div>

    <!-- ======= Header ======= -->
    <header id="header" class="fixed-top">
        <div class="container d-flex align-items-center">

            <h1 class="logo me-auto"><a href="index.html">Lab Appointment System</a></h1>
            <nav id="navbar" class="navbar order-last order-lg-0">
                <ul>
                    <li><a class="nav-link scrollto" href="index.html">Home</a></li>
                    <li><a class="nav-link scrollto" href="patient.html">Patients</a></li>
                    <li><a class="nav-link scrollto" href="doctor.html">Doctor</a></li>
                    <li><a class="nav-link scrollto" href="test.html">Test</a></li>
                    <li><a class="nav-link scrollto" href="appointment.html">Apointment</a></li>
                    <li><a class="nav-link scrollto active" href="report.html">Report</a></li>
                </ul>
                <i class="bi bi-list mobile-nav-toggle"></i>
            </nav><!-- .navbar -->

            <!-- <a href="#appointment" class="appointment-btn scrollto"><span class="d-none d-md-inline">Make an</span>
                Appointment</a> -->

            <a href="login.html" id="loginButton" class="appointment-btn scrollto"><span
                    class="d-none d-md-inline">Login</span></a>

            <button id="logoutButton" onclick="Logout()" class="appointment-btn scrollto"><span
                    class="d-none d-md-inline" style="display: none;">Logout <i
                        class="fa-solid fa-right-from-bracket"></i></span></button>

        </div>
    </header><!-- End Header -->


    <!-- End Header -->

    <!-- ======= Hero Section ======= -->
    <section id="hero" class="d-flex align-items-center">
        <div class="container">
            <h1>Welcome to <br> technician Portal</h1>
            <h2>Manage everything here</h2>

        </div>
    </section><!-- End Hero -->

    <main id="main">

        <!-- ======= Why Us Section ======= -->
        <section id="why-us" class="why-us">
            <div class="container">

                <div class="row">

                    <div class="col-lg-8 d-flex align-items-stretch">
                        <div class="icon-boxes d-flex flex-column justify-content-center">
                            <div class="row">
                                <div class="col-xl-6 d-flex align-items-stretch">
                                    <a href="#viewTestResult">
                                        <div class="icon-box mt-4 mt-xl-0">
                                            <i class="bx bx-receipt"></i>
                                            <h4>View Report</h4>
                                            <p>View all registered Report and manage their information.</p>

                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div><!-- End .content-->
                    </div>
                </div>

            </div>
        </section><!-- End Why Us Section -->


        <!-- ======= Counts Section ======= -->
        <section id="viewTestResult" class="counts">
            <div class="container">

                <div class="row">

                    <h2 class="text-center mb-3">View All Reports</h2>
                    <div class="col-lg-12 col-md-12">
                        <table class="table table-dark table-hover">
                            <thead>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Appointment No</th>
                                <th>Appointment Date</th>
                                <th>Action</th>
                            </thead>
                            <tbody id="tbody"></tbody>
                        </table>
                    </div>

                </div>

            </div>
        </section><!-- End Counts Section -->

        <!-- Modal -->
        <div class="modal" id="reportModal">
            <div class="modal-content">
                <div class="modal-header" id="modalHeader"></div>
                <div id="modalBody"></div>
            </div>
        </div>



    </main><!-- End #main -->

    <!-- ======= Footer ======= -->
    <footer id="footer">
        <div class="container d-md-flex py-4">

            <div class="me-md-auto text-center text-md-start">
                <div class="copyright">
                    &copy; Copyright <strong><span>Lab Appointment System</span></strong>. All Rights Reserved
                </div>
                <div class="credits">
                    Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
                </div>
            </div>
            <div class="social-links text-center text-md-right pt-3 pt-md-0">
                <a href="#" class="twitter"><i class="bx bxl-twitter"></i></a>
                <a href="#" class="facebook"><i class="bx bxl-facebook"></i></a>
                <a href="#" class="instagram"><i class="bx bxl-instagram"></i></a>
                <a href="#" class="google-plus"><i class="bx bxl-skype"></i></a>
                <a href="#" class="linkedin"><i class="bx bxl-linkedin"></i></a>
            </div>
        </div>
    </footer><!-- End Footer -->


    <div id="preloader"></div>
    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
            class="bi bi-arrow-up-short"></i></a>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.debug.js"></script>
    <script src="assets/js/api.js"></script>

    <script>

        // Check if username exists in localStorage
        if (!localStorage.getItem('username')) {
            // If not, redirect to login page
            window.location.href = 'login.html';
        }
        else {

            const loginButton = document.getElementById('loginButton');
            loginButton.style.display = 'none';

            const logoutButton = document.getElementById('logoutButton');
            logoutButton.style.display = 'block';
        }

        // Call the function to fetch and bind the report lis
        var patient = '';
        getAllReports();

        function Logout() {
            localStorage.removeItem("tusername");
            window.location.href = 'login.html';
        }

        async function addReport() {
            var appointmentID = document.getElementById("appointmentID").value;
            const reportDetails = tinymce.get('reportDetails').getContent();

            const reportData = await geReportByApointmentId(appointmentID);
            debugger;
            if (reportData) {
                swal("Failed to add report!", "report exist, You can Edit the report", "error");
                editReport(reportData.reportID);
            }
            else {
                var report = {
                    appointmentID: appointmentID,
                    reportDetails: reportDetails
                };
                fetch(baseUrl + '/LabAppointment-Service/resources/report/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(report)
                })
                    .then(response => {
                        if (response.ok) {
                            swal("Report added successfully!", "", "success")
                                .then(() => {
                                    getAllReports();
                                    //document.getElementById("AppointmentID").value = "";
                                    tinymce.get('reportDetails').setContent('');
                                    window.location.href = "report.html#viewReport";
                                });
                        } else {
                            swal("Failed to add report!", "Try again", "error");
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        swal("Failed to add report!", "Try again", "error");
                    });
            }

        }

        function updateReport() {
            var reportID = document.getElementById("reportID").value;
            var appointmentID = document.getElementById("appointmentID").value;
            const reportDetails = tinymce.get('reportDetails').getContent();

            var report = {
                reportID: reportID,
                appointmentID: appointmentID,
                reportDetails: reportDetails
            };

            fetch(baseUrl + '/LabAppointment-Service/resources/report/' + reportID, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(report)
            })
                .then(response => {
                    if (response.ok) {
                        swal("Report updated successfully!", "", "success")
                            .then(() => {
                                getAllReports();
                                document.getElementById("reportID").value = "";
                                //document.getElementById("AppointmentID").value = "";
                                tinymce.get('reportDetails').setContent('');
                                window.location.href = "report.html#viewReport";
                            });
                    } else {
                        swal("Failed to update report!", "Try again", "error");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    swal("Failed to update report!", "Try again", "error");
                });
        }

        function getAllReports() {
            fetch(baseUrl + '/LabAppointment-Service/resources/report')
                .then(response => response.json())
                .then(async data => {
                    // Get the table body element
                    const tbody = document.getElementById('tbody');
                    // Clear existing table rows
                    tbody.innerHTML = '';
                    patient = await getPatientByUserName(localStorage.getItem('username'));
                    data.forEach(async report => {
                        const appointment = await getAppointmentById(report.appointmentID);
                        if (appointment.patientID == patient.patientID) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                    <td>${report.reportID}</td>
                                    <td>${patient.firstName} ${patient.lastName}</td>
                                    <td>${report.appointmentID}</td>
                                    <td>${appointment.appointmentDateTime}</td>
                                    <td>
                                        <button class='btn btn-outline-primary' onclick='viewReport(${report.reportID})'><i class="fa-sharp fa-regular fa-eye"></i></i></button>
                                        
                                    </td>`;
                            tbody.appendChild(tr);
                        }

                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });


        }

        function viewReport(reportID) {
            // Fetch the report data by ID
            fetch(baseUrl + `/LabAppointment-Service/resources/report/${reportID}`)
                .then(response => response.json())
                .then(async data => {
                    const appointment = await getAppointmentById(data.appointmentID);
                    var patient = '';
                    if (appointment) {
                        patient = await getPatientById(appointment.patientID);
                    }
                    const modalHeader = document.getElementById('modalHeader');
                    modalHeader.innerHTML = `
                    <h1 class='modal-title fs-5' id='reportModal'>Report Details</h1>
                    <div class='row col-2' style='margin-left:20%;'>
                        <div class='col-1' style='margin-left:20%;'>
                            <button class='btn btn-outline-success' 
                                onclick='downloadReport()'>
                                <i class='fa-solid fa-download'></i>
                            </button>
                        </div>
                        <div class='col-1' style='margin-left:20%;'>
                            <button class='btn btn-outline-danger' 
                                onclick='closeModal()'>
                                <i class="fa-regular fa-circle-xmark"></i>
                            </button>
                        </div>
                    </div>`;
                    // Populate the modal body with the report data
                    const modalBody = document.getElementById('modalBody');
                    modalBody.innerHTML = `
                        <div class='mt-5'>
                            <p><strong>Report ID:</strong> ${data.reportID}</p>
                            <p><strong>Patient Name:</strong> ${patient.firstName} ${patient.lastName}</p>
                            <p><strong>Appointment ID:</strong> ${data.appointmentID}</p>
                            <p><strong>Appointment Date:</strong> ${appointment.appointmentDateTime}</p>
                        </div>
                        <div>
                            <p><strong>Report Details:</strong></p> 
                            ${data.reportDetails}
                        </div>
                    `;

                    // Display the modal
                    document.getElementById('reportModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function closeModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        // async function downloadReport(reportID, appointmentID, patientID) {
        //     const patient = await getPatientById(patientID);
        //     const appointment = await getAppointmentById(appointmentID);
        //     const report = await geReportById(reportID);

        //     const modalBody = document.getElementById('modalBody');
        //     const patientName = `${patient.firstName} ${patient.lastName}`;
        //     //const appointmentID = appointment.appointmentID;
        //     const appointmentDate = appointment.appointmentDateTime;
        //     const reportDetails = report.reportDetails;


        //     const pdf = new jsPDF();
        //     pdf.text(`Patient Name: ${patientName}`, 10, 10);
        //     pdf.text(`Appointment ID: ${appointmentID}`, 10, 20);
        //     pdf.text(`Appointment Date: ${appointmentDate}`, 10, 30);
        //     pdf.text(`Report Details: ${reportDetails}`, 10, 40);

        //     pdf.save('report.pdf');
        // }

        async function downloadReport() {
            const pdf = new jsPDF();
            pdf.fromHTML(modalBody.outerHTML, 10, 10);
            pdf.save('report.pdf');
        }






    </script>


    <!-- Vendor JS Files -->
    <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>

    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>

</body>

</html>